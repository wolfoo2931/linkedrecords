<html>
    <head>

        <script>exports = {} // because of the export system used in diff_match_patch</script>

        <script type="text/javascript" src="node_modules/changesets/client-side.js"></script>
        <script type="text/javascript" src="node_modules/diff_match_patch/lib/diff_match_patch.js"></script>

        <style>
            #value {
                margin: 0px auto;
                background-color: #efefef;
                width: 500px;
                min-height: 300px;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 9px;
            }

            #value:focus {
                border: 1px solid #ddd;
                outline: none;
            }
        </style>
    </head>
    <body>


        <div contenteditable="true" id="value"></div>


        <script type="text/javascript" src="http://localhost:3000/bayeux/client.js"></script>
        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

        <script>
        function generateUUID() {
            var d = new Date().getTime();
            var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = (d + Math.random()*16)%16 | 0;
                d = Math.floor(d/16);
                return (c=='x' ? r : (r&0x3|0x8)).toString(16);
            });
            return uuid;
        };
        </script>

        <script>
            var client = new Faye.Client('http://localhost:3000/bayeux');
            var clientId = actorId = generateUUID();
            var Changeset = changesets.Changeset;

            var RemoveVariable = function (variableId) {
                this.variableId = variableId;
                this.diffEngine = new exports.diff_match_patch();
                this.sendBuffer = [];
                this.receiveBuffer = [];

                // The change sent to the server but not yet acknowledged.
                this.changeInTransmission;
            }

            RemoveVariable.prototype = {
                load: function(done) {
                    var self = this;

                    $.ajax({url: 'http://localhost:3000/variables/' + this.variableId}).done((result) => {
                        self.parentVersion = result.changeId;
                        self.value = result.value;

                        client.subscribe('/changes/variable/' + self.variableId, function(change) {
                            if(change.clientId === clientId) {
                                self._processApproval(change);
                            } else {
                                self._processForeignChange(change);
                            }
                        });

                        self.render();
                        done && done();
                    });

                    return self;
                },

                _processForeignChange: function(change) {
                    if(this.changeInTransmission) {
                        this.receiveBuffer.push(change);
                    } else {
                        try {
                            this.value = Changeset.unpack(change.transformedClientChange).apply(this.value);
                            this.parentVersion = change.id;
                            this.render();
                        } catch (ex) {}
                    }
                },

                _processApproval: function(change) {
                    this.value = Changeset.unpack(change.transformedServerChange).apply(this.value);
                    this.parentVersion = change.id;
                    this.changeInTransmission = null;
                    console.log('change ' + change.id + ' approved', 'current send buffer size ' + this.sendBuffer.length);
                    this.render();
                },

                // As it is only allowed to sent one change to the server at a time
                // the returned changeset of this method includes all local changes made
                // while the change is in transmission.
                _composedSendBuffer: function() {
                    var clonedBuffer = this.sendBuffer.slice(0),
                        composedCS = clonedBuffer.shift();

                    clonedBuffer.forEach(function(change) {
                        composedCS = composedCS.transformAgainst(change);
                    });

                    return composedCS;
                },

                getValue: function() {
                    return this.value;
                },

                // Update the content on the local client, buffer
                // and propagate the change to the server (execute whenever the user
                // performs some input on the document)
                setValue: function(tmpValue) {

                    tmpValue = tmpValue.replace(/<div>/gi, '').replace(/<\/div>/gi, '');

                    var diff = this.diffEngine.diff_main(this.value, tmpValue);
                    var changeset = Changeset.fromDiff(diff);

                    if(this.changeInTransmission) {
                        this.sendBuffer.push(changeset);
                    } else {
                        this.changeInTransmission = {
                            variableId: this.variableId,
                            change: {
                                changeset: changeset.pack(),
                                parentVersion: this.parentVersion
                            },
                            actorId: actorId,
                            clientId: clientId
                        };

                        this.value = changeset.apply(this.value);

                        client.publish('/uncommited/changes/variable/' + self.variableId, this.changeInTransmission);
                    }
                },

                render: function() {
                    var range,
                        domEl = $('#value'),
                        selectionStart,
                        selectionEnd,
                        anchorNode,
                        focusNode;

                        // get the current cursor position because the cursor will be moved to 0
                        // once we modified the html contnent
                        selection = $('#value:focus').length == 1 ? window.getSelection() : null;


                    if(selection) {
                        selectionStart = selection.anchorOffset;
                        selectionEnd = selection.focusOffset;
                        anchorNode = selection.anchorNode;
                        focusNode = selection.focusNode;
                    }

                    domEl.html(this.getValue());

                    if(selectionStart && selectionEnd) {
                        range = document.createRange();
                        console.log(document.getElementById('value').firstChild);
                        range.setStart(document.getElementById('value').firstChild, selectionStart);
                        range.setEnd(document.getElementById('value').firstChild, selectionEnd);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                }
            }

            $().ready(function() {
                var client = new Faye.Client('http://localhost:3000/bayeux');
                var remoteVariable = new RemoveVariable('d82384b8-24c4-4ada-a467-86b82a252cc9').load();

                $('#value').on('input', function() {
                    remoteVariable.setValue($('#value').html());
                });

            });

        </script>
    </body>
</html>
