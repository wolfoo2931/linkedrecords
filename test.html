<html>
    <head>

        <script>exports = {} // because of the export system used in diff_match_patch</script>

        <script type="text/javascript" src="http://localhost:3000/bayeux/client.js"></script>
        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

        <script type="text/javascript" src="node_modules/changesets/client-side.js"></script>
        <script type="text/javascript" src="node_modules/diff_match_patch/lib/diff_match_patch.js"></script>

        <script type="text/javascript" src="js_sdk/uuid.js"></script>
        <script type="text/javascript" src="js_sdk/caret.js"></script>
        <script type="text/javascript" src="js_sdk/remote_variable.js"></script>

        <style>
            #value {
                margin: 0px auto;
                background-color: #efefef;
                width: 500px;
                min-height: 300px;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 9px;
            }

            #value:focus {
                border: 1px solid #ddd;
                outline: none;
            }
        </style>

    </head>
    <body>

        <div contenteditable="true" id="value"></div>

        <div contenteditable="true" id="caretTest1">test <b>the caret</b> position <br/> <div id="caretTest1StopElement">with breaks in the text</div></div>

        <script>

            $().ready(function() {
                var bayeuxClient = new Faye.Client('http://localhost:3000/bayeux'),
                    clientId = actorId = (new UUID()).getValue(),
                    remoteVariable = new RemoveVariable('c1816608-c4c8-472c-8e0f-5f3c30b3fd24', bayeuxClient, clientId, actorId).load(),
                    caret = new Caret();

                remoteVariable.on('change', function(changeset) {
                    var range,
                        domEl = $('#value'),
                        selectionStart,
                        selectionEnd,
                        anchorNode,
                        focusNode,

                        // get the current cursor position because the cursor will be moved to 0
                        // once we modified the html contnent
                        selection = $('#value:focus').length == 1 ? window.getSelection() : null;


                    if(selection) {
                        selectionStart = selection.anchorOffset;
                        selectionEnd = selection.focusOffset;
                        anchorNode = selection.anchorNode;
                        focusNode = selection.focusNode;
                    }

                    domEl.html(remoteVariable.getValue());

                    if(selectionStart && selectionEnd) {
                        range = document.createRange();
                        range.setStart(document.getElementById('value').firstChild, selectionStart);
                        range.setEnd(document.getElementById('value').firstChild, selectionEnd);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                });

                $('#value').on('input', function() {
                    remoteVariable.setValue($('#value').html());
                });

                $('#value').on('click', function() {
                    new Caret().saveSelection(document.getElementById('value'));
                });
            });

        </script>
    </body>
</html>
